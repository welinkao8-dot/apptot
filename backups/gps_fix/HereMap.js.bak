import React, { useRef, useImperativeHandle, forwardRef } from 'react';
import { StyleSheet, View } from 'react-native';
import { WebView } from 'react-native-webview';

const HERE_API_KEY = 'UN2gxhPRLhPhUiKVSUTeegOmmDuDwsFcPsQZhX8V040';

const HereMap = forwardRef(({ initialCenter, onMapReady }, ref) => {
    const webViewRef = useRef(null);

    const injectJS = (code) => {
        webViewRef.current?.injectJavaScript(code);
    };

    useImperativeHandle(ref, () => ({
        setUserLocation: (coords) => {
            injectJS(`window.setUserLocation(${JSON.stringify(coords)});`);
        },
        setMarkers: (origin, destination) => {
            injectJS(`window.setMarkers(${JSON.stringify(origin)}, ${JSON.stringify(destination)});`);
        },
        drawRoute: (geometry) => {
            injectJS(`window.drawRoute(${JSON.stringify(geometry)});`);
        },
        setDriverPosition: (position, isArriving = false) => {
            injectJS(`window.updateDriverMarker(${JSON.stringify(position)}, ${isArriving});`);
        },
        clearMap: () => {
            injectJS(`window.clearMap();`);
        },
        centerOn: (coords, zoom = 15) => {
            injectJS(`window.centerOn(${JSON.stringify(coords)}, ${zoom});`);
        }
    }));

    const htmlContent = `
    <!DOCTYPE html>
    <html lang="pt">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
        <title>TOT Map Bulletproof</title>
        
        <link rel="stylesheet" type="text/css" href="https://js.api.here.com/v3/3.2/mapsjs-ui.css" />
        <script type="text/javascript" src="https://js.api.here.com/v3/3.2/mapsjs-core.js"></script>
        <script type="text/javascript" src="https://js.api.here.com/v3/3.2/mapsjs-service.js"></script>
        <script type="text/javascript" src="https://js.api.here.com/v3/3.2/mapsjs-ui.js"></script>
        <script type="text/javascript" src="https://js.api.here.com/v3/3.2/mapsjs-mapevents.js"></script>
        
        <style>
            body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background-color: #f1f5f9; }
            #mapContainer { 
                position: absolute; top: 0; left: 0; bottom: 0; right: 0;
                width: 100%; height: 100%; background: #f1f5f9;
            }
            .H_copyright { display: none !important; }
            
            /* Enhanced Pin Marker Styling */
            .pin-container { position: relative; width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; }
            .pin-svg { 
                filter: drop-shadow(0 2px 3px rgba(0,0,0,0.25)); /* Reduced shadow by 50% */
                transform: translateY(-26px); /* Elevate more for better visibility */
            }
            
            /* Pulse Effect for Driver Arrival */
            .pulse-ring { 
                position: absolute; width: 50px; height: 50px; border-radius: 50%; 
                background: rgba(0, 140, 149, 0.4); animation: ping 1.5s infinite; 
                transform: translateY(-20px);
            }
            @keyframes ping { 0% { transform: translateY(-20px) scale(0.5); opacity: 1; } 100% { transform: translateY(-20px) scale(2.5); opacity: 0; } }
        </style>
    </head>
    <body onload="init()">
        <div id="mapContainer"></div>
        <script>
            let map, platform, ui, behavior, layers;
            let activeMarkers = { user: null, origin: null, dest: null, driver: null };
            let routeGroup = null;

            // Premium Solid Flat Teardrop SVG Maker
            const makePinHtml = (color, pulse = false) => {
                const ring = pulse ? '<div class="pulse-ring"></div>' : '';
                return \`
                    <div class="pin-container">
                        \${ring}
                        <svg class="pin-svg" xmlns="http://www.w3.org/2000/svg" width="56" height="56" viewBox="0 0 24 24">
                            <path fill="\${color}" 
                                  d="M12 2C8.13 2 5 5.13 5 9c0,5.25 7,13 7,13s7-7.75 7-13c0-3.87-3.13-7-7-7z"/>
                        </svg>
                    </div>\`;
            };

            function init() {
                try {
                    platform = new H.service.Platform({ 
                        apikey: '${HERE_API_KEY}',
                        useHTTPS: true 
                    });
                    layers = platform.createDefaultLayers();
                    const mapLayer = layers.raster.normal.map;

                    map = new H.Map(
                        document.getElementById('mapContainer'),
                        mapLayer,
                        {
                            center: ${JSON.stringify(initialCenter || { lat: -8.839, lng: 13.289 })},
                            zoom: 14,
                            pixelRatio: window.devicePixelRatio || 1
                        }
                    );

                    behavior = new H.mapevents.Behavior(new H.mapevents.MapEvents(map));
                    
                    // Removed default UI controls (zoom and map switcher) for a cleaner UX
                    // ui = H.ui.UI.createDefault(map, layers);

                    const forceResize = () => map.getViewPort().resize();
                    window.addEventListener('resize', forceResize);
                    setTimeout(forceResize, 500);
                    setTimeout(forceResize, 1500);

                    window.ReactNativeWebView.postMessage(JSON.stringify({ type: 'READY' }));
                } catch (e) {
                    window.ReactNativeWebView.postMessage(JSON.stringify({ type: 'LOG', msg: 'Init Error: ' + e.message }));
                }
            }

            window.setUserLocation = (c) => {
                if (activeMarkers.user) map.removeObject(activeMarkers.user);
                const icon = new H.map.DomIcon(makePinHtml('#E91E63')); // Now Pink
                activeMarkers.user = new H.map.DomMarker(c, { icon });
                map.addObject(activeMarkers.user);
                map.setCenter(c, true);
            };

            window.setMarkers = (o, d) => {
                if (activeMarkers.origin) map.removeObject(activeMarkers.origin);
                if (activeMarkers.dest) map.removeObject(activeMarkers.dest);
                if (o) {
                    const icon = new H.map.DomIcon(makePinHtml('#E91E63')); // Now Pink
                    activeMarkers.origin = new H.map.DomMarker(o, { icon });
                    map.addObject(activeMarkers.origin);
                }
                if (d) {
                    const icon = new H.map.DomIcon(makePinHtml('#10b981')); // Now Green
                    activeMarkers.dest = new H.map.DomMarker(d, { icon });
                    map.addObject(activeMarkers.dest);
                }
            };

            window.drawRoute = (data) => {
                try {
                    if (routeGroup) map.removeObject(routeGroup);
                    if (!data) return;

                    let lineString;
                    if (typeof data === 'string') {
                        lineString = H.geo.LineString.fromFlexiblePolyline(data);
                    } else if (Array.isArray(data)) {
                        lineString = new H.geo.LineString();
                        data.forEach(p => lineString.pushPoint({ lat: p[0], lng: p[1] }));
                    }

                    if (!lineString || lineString.getPointCount() === 0) return;

                    const routeLine = new H.map.Polyline(lineString, {
                        style: { strokeColor: '#E91E63', lineWidth: 6, lineCap: 'round', lineJoin: 'round' }
                    });
                    
                    routeGroup = new H.map.Group();
                    routeGroup.addObjects([routeLine]);
                    
                    map.addObject(routeGroup);
                    
                    const bounds = routeGroup.getBoundingBox();
                    if (bounds) {
                        map.getViewModel().setLookAtData({ 
                            bounds: bounds,
                            padding: { top: 120, bottom: 120, left: 60, right: 60 }
                        }, true);
                    }
                } catch (e) {
                    window.ReactNativeWebView.postMessage(JSON.stringify({ type: 'LOG', msg: 'drawRoute Error: ' + e.message }));
                }
            };

            window.updateDriverMarker = (pos, isArriving) => {
                if (activeMarkers.driver) map.removeObject(activeMarkers.driver);
                const icon = new H.map.DomIcon(makePinHtml('#008C95', isArriving));
                activeMarkers.driver = new H.map.DomMarker(pos, { icon });
                map.addObject(activeMarkers.driver);
            };

            window.clearMap = () => {
                Object.values(activeMarkers).forEach(m => m && map.removeObject(m));
                if (routeGroup) map.removeObject(routeGroup);
                activeMarkers = { user: activeMarkers.user, origin: null, dest: null, driver: null };
            };

            window.centerOn = (c, z) => { map.setCenter(c, true); if (z) map.setZoom(z, true); };
        </script>
    </body>
    </html>
    `;

    return (
        <View style={styles.container}>
            <WebView
                ref={webViewRef}
                originWhitelist={['*']}
                // SPOOF BASE URL to bypass potential domain restrictions and use HTTPS as origin
                source={{ html: htmlContent, baseUrl: 'https://www.here.com' }}
                style={styles.webview}
                onMessage={(e) => {
                    try {
                        const d = JSON.parse(e.nativeEvent.data);
                        if (d.type === 'READY' && onMapReady) onMapReady();
                        if (d.type === 'LOG') console.log('ðŸ—ºï¸ [WebView Map Debug]:', d.msg);
                    } catch (err) { }
                }}
                javaScriptEnabled={true}
                domStorageEnabled={true}
                mixedContentMode="always"
                allowFileAccess={true}
            />
        </View>
    );
});

const styles = StyleSheet.create({
    container: { flex: 1, backgroundColor: '#f1f5f9' },
    webview: { flex: 1, backgroundColor: 'transparent' }
});

export default HereMap;

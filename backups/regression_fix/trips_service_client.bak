import { Injectable } from '@nestjs/common';
import { PrismaService } from '@app/database';
import { CreateTripDto } from './dto/create-trip.dto';

@Injectable()
export class TripsService {
    constructor(private prisma: PrismaService) { }

    async create(createTripDto: CreateTripDto, userId: string) {
        // 1. Check active trip
        const active = await this.prisma.trips.findFirst({
            where: {
                client_id: userId,
                status: { in: ['requested', 'accepted', 'ongoing'] }
            },
            orderBy: { created_at: 'desc' }
        });

        if (active) return active;

        // 2. Create new
        return this.prisma.trips.create({
            data: {
                client_id: userId,
                origin_address: createTripDto.originAddress,
                dest_address: createTripDto.destAddress,
                estimated_fare: createTripDto.price,
                status: 'requested',
                origin_lat: createTripDto.originLat,
                origin_lng: createTripDto.originLng,
                // Driver ID null initially
            },
        });
    }

    async getHistory(userId: string, limit: number = 20, status?: string, month?: number, year?: number) {
        let where: any = { client_id: userId };

        if (status && status !== 'all') {
            where.status = status;
        } else {
            where.status = { in: ['completed', 'cancelled'] };
        }

        if (month !== undefined && year !== undefined) {
            const startDate = new Date(year, month, 1);
            const endDate = new Date(year, month + 1, 0, 23, 59, 59);
            where.created_at = {
                gte: startDate,
                lte: endDate
            };
        }

        return this.prisma.trips.findMany({
            where,
            orderBy: { created_at: 'desc' },
            take: limit,
            include: {
                profiles_trips_driver_idToprofiles: true,
                invoices: true
            }
        });
    }

    async getMonthlyStats(userId: string) {
        const now = new Date();
        const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);

        const trips = await this.prisma.trips.findMany({
            where: {
                client_id: userId,
                status: 'completed',
                created_at: { gte: startOfMonth }
            },
            select: { final_fare: true }
        });

        const totalSpent = trips.reduce((sum, trip) => {
            return sum + (trip.final_fare ? parseFloat(trip.final_fare.toString()) : 0);
        }, 0);

        return {
            count: trips.length,
            total: totalSpent
        };
    }

    async findActive(userId: string) {
        return this.prisma.trips.findFirst({
            where: {
                client_id: userId,
                status: { in: ['requested', 'accepted', 'ongoing'] }
            },
            orderBy: { created_at: 'desc' },
            include: { profiles_trips_driver_idToprofiles: true }
        });
    }

    async cancel(tripId: string, userId: string) {
        // Ensure ownership
        return this.prisma.trips.updateMany({
            where: { id: tripId, client_id: userId },
            data: { status: 'cancelled' }
        });
    }
}

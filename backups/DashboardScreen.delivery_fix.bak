import React, { useState, useEffect, useRef } from 'react';
import {
    View,
    Text,
    StyleSheet,
    TouchableOpacity,
    SafeAreaView,
    StatusBar,
    Animated,
    Dimensions,
    FlatList,
    Image,
    ScrollView,
    TextInput,
} from 'react-native';
import {
    Menu,
    Search,
    Navigation,
    MapPin,
    Clock,
    Package,
    Bike,
    Car,
    ChevronRight,
    Star,
    Shield,
    CheckCircle,
    X,
    Heart,
    User,
    ArrowLeft,
    Truck,
    Smartphone,
    CreditCard
} from 'lucide-react-native';
import colors from '../theme/colors';
import socket from '../services/socket';
import api from '../services/api';
import hereService from '../services/hereService';
import { useAuth } from '../context/AuthContext';
import Toast from 'react-native-toast-message';

const { width, height } = Dimensions.get('window');

export default function DashboardScreen({ navigation }) {
    const { user, signOut } = useAuth();
    const [step, setStep] = useState('home');
    const [loading, setLoading] = useState(false);
    const [destination, setDestination] = useState(null); // { name, address, lat, lng }
    const [pickupAddress, setPickupAddress] = useState('Luanda, Angola');
    const [pickupCoords, setPickupCoords] = useState({ lat: -8.839, lng: 13.289 });
    const [selectedService, setSelectedService] = useState(null); // { id, name, price, ... }
    const [selectedCategory, setSelectedCategory] = useState(null);
    const [availableServices, setAvailableServices] = useState([]);
    const [calculatedServices, setCalculatedServices] = useState([]);
    const [tripId, setTripId] = useState(null);
    const [acceptedDriver, setAcceptedDriver] = useState(null);
    const [currentFare, setCurrentFare] = useState(0);
    const [searchQuery, setSearchQuery] = useState('');
    const [searchResults, setSearchResults] = useState([]);

    const radarAnim = useRef(new Animated.Value(0)).current;
    const paymentAnim = useRef(new Animated.Value(0)).current;

    useEffect(() => {
        const delayDebounceFn = setTimeout(async () => {
            if (searchQuery.length >= 3) {
                const results = await hereService.fetchSuggestions(searchQuery, pickupCoords);
                setSearchResults(results);
            } else {
                setSearchResults([]);
            }
        }, 500);

        return () => clearTimeout(delayDebounceFn);
    }, [searchQuery]);

    useEffect(() => {
        if (step === 'requesting') {
            Animated.loop(
                Animated.sequence([
                    Animated.timing(radarAnim, {
                        toValue: 1,
                        duration: 1500,
                        useNativeDriver: false
                    }),
                    Animated.timing(radarAnim, {
                        toValue: 0,
                        duration: 0,
                        useNativeDriver: false
                    })
                ])
            ).start();
        } else {
            radarAnim.setValue(0);
        }

        if (step === 'waiting_payment') {
            Animated.loop(
                Animated.timing(paymentAnim, {
                    toValue: 1,
                    duration: 2000,
                    useNativeDriver: false
                })
            ).start();
        } else {
            paymentAnim.setValue(0);
        }
    }, [step]);

    useEffect(() => {
        loadServices();
    }, []);

    const loadServices = async () => {
        try {
            const response = await api.getServices();
            setAvailableServices(response.data);
        } catch (error) {
            console.error('Error loading services:', error);
            Toast.show({ type: 'error', text1: 'Erro', text2: 'Não foi possível carregar os serviços' });
        }
    };

    // Socket Setup
    useEffect(() => {
        socket.connect();
        socket.emit('join', { userId: user.id, role: 'client' });

        socket.on('trip_created', (data) => {
            console.log('Trip created:', data);
            setTripId(data.tripId);
            setStep('requesting');
        });

        socket.on('trip_accepted', (data) => {
            console.log('Trip accepted:', data);
            setAcceptedDriver(data.driver);
            setStep('accepted');
            setLoading(false);
            Toast.show({ type: 'success', text1: 'Motorista encontrado!', text2: `${data.driver.name} está a caminho` });
        });

        socket.on('ride_started', () => {
            setStep('ongoing');
            Toast.show({ type: 'info', text1: 'Viagem iniciada', text2: 'Tenha uma boa viagem!' });
        });

        socket.on('trip_update', (data) => {
            if (data.currentFare) setCurrentFare(data.currentFare);
        });

        socket.on('ride_finished', (data) => {
            setStep('waiting_payment');
            setCurrentFare(data.finalFare);
        });

        socket.on('payment_confirmed', (data) => {
            setStep('finished');
            if (data.finalFare) setCurrentFare(data.finalFare);
            Toast.show({ type: 'success', text1: 'Pagamento Confirmado', text2: 'Sua viagem foi concluída com sucesso.' });
        });

        socket.on('trip_cancelled_confirmed', () => {
            resetFlow();
            Toast.show({ type: 'success', text1: 'Corrida cancelada!', text2: 'A sua solicitação foi cancelada com sucesso.' });
        });

        socket.on('trip_cancelled', () => {
            resetFlow();
            Toast.show({ type: 'error', text1: 'Viagem Cancelada', text2: 'O motorista cancelou a viagem' });
        });

        socket.on('trip_timeout', () => {
            resetFlow();
            Toast.show({ type: 'warning', text1: 'Sem motoristas', text2: 'Não encontramos motoristas no momento' });
        });

        return () => {
            socket.off('trip_created');
            socket.off('trip_accepted');
            socket.off('ride_started');
            socket.off('trip_update');
            socket.off('ride_finished');
            socket.off('payment_confirmed');
            socket.off('trip_cancelled');
            socket.off('trip_cancelled_confirmed');
            socket.off('trip_timeout');
            socket.disconnect();
        };
    }, []);

    const resetFlow = () => {
        setStep('home');
        setTripId(null);
        setAcceptedDriver(null);
        setLoading(false);
        setDestination(null);
        setSelectedService(null);
        setCurrentFare(0);
    };

    const handleCancelRide = () => {
        if (tripId) {
            console.log('Cancelling trip:', tripId);
            socket.emit('cancel_trip', { tripId });
        } else {
            resetFlow();
        }
    };

    const handleSelectDestination = (dest) => {
        setDestination(dest);
        setStep('home');
    };

    const haversine = (lat1, lon1, lat2, lon2) => {
        const R = 6371; // Radius of the earth in km
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
            Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
            Math.sin(dLon / 2) * Math.sin(dLon / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c; // Distance in km
    };

    const calculateFares = (destLat, destLng, category) => {
        const originLat = pickupCoords.lat;
        const originLng = pickupCoords.lng;

        const distKm = haversine(originLat, originLng, destLat, destLng);
        // Estimate time: 2 mins per km + 2 mins base
        const durMin = (distKm * 2) + 2;

        const calculated = availableServices
            .filter(service => service.category === category)
            .map(service => {
                const base = parseFloat(service.base_fare || 0);
                const pKm = parseFloat(service.price_per_km || 0);
                const pMin = parseFloat(service.price_per_min || 0);
                const minFare = parseFloat(service.min_fare || 0);

                let total = base + (distKm * pKm) + (durMin * pMin);
                total = Math.max(total, minFare);

                return {
                    ...service,
                    estimatedPrice: Math.round(total),
                    estimatedTime: Math.ceil(durMin)
                };
            });
        setCalculatedServices(calculated);
    };

    const handleCategorySelect = (categoryId) => {
        if (!destination) {
            setStep('searching_address');
            Toast.show({ type: 'info', text1: 'Defina o destino', text2: 'Para ver as ofertas, escolha o destino primeiro' });
        } else {
            setSelectedCategory(categoryId);
            // Calculate fares before showing list
            const destLat = destination.lat || -8.840;
            const destLng = destination.lng || 13.290;
            calculateFares(destLat, destLng, categoryId);

            setStep('service_selection');
        }
    };

    const handleServiceSelect = (service) => {
        setSelectedService(service);
    };

    const handleRequestTrip = () => {
        if (!destination || !selectedService) return;

        const tripPayload = {
            clientId: user.id,
            userName: user.full_name,
            originAddress: pickupAddress,
            destAddress: destination.name,
            originLat: pickupCoords.lat,
            originLng: pickupCoords.lng,
            destLat: destination.lat || -8.840,
            destLng: destination.lng || 13.290,
            category: selectedService.category || 'ride',
            price: selectedService.estimatedPrice,
            serviceConfigId: selectedService.id
        };
        socket.emit('request_trip', tripPayload);
        setLoading(true);
    };

    const renderHeader = () => (
        <View style={styles.headerFloating}>
            <TouchableOpacity style={styles.iconCircle} onPress={() => navigation.openDrawer()}>
                <Menu size={24} color={colors.text} />
            </TouchableOpacity>
            {step === 'home' && (
                <View style={styles.userInfo}>
                    <Text style={styles.welcomeText}>Olá, {user?.full_name?.split(' ')[0]}</Text>
                    <Text style={styles.locationLabel}>Luanda, Angola</Text>
                </View>
            )}
            <TouchableOpacity style={styles.iconCircle}>
                <Search size={24} color={colors.text} />
            </TouchableOpacity>
        </View>
    );

    const renderStepContent = () => {
        switch (step) {
            case 'home':
                return (
                    <View style={styles.bottomSheet}>
                        <Text style={styles.sheetTitle}>Para onde vamos hoje?</Text>
                        <TouchableOpacity
                            style={[styles.searchBar, destination && styles.searchBarActive]}
                            onPress={() => setStep('searching_address')}
                        >
                            {!destination ? (
                                <>
                                    <MapPin size={20} color={colors.primary} />
                                    <Text style={styles.searchText}>Digite seu destino...</Text>
                                </>
                            ) : (
                                <>
                                    <View style={styles.destinationDot} />
                                    <Text style={styles.searchTextActive}>{destination.name}</Text>
                                    <TouchableOpacity style={{ marginLeft: 'auto' }} onPress={() => setDestination(null)}>
                                        <X size={18} color={colors.textSecondary} />
                                    </TouchableOpacity>
                                </>
                            )}
                        </TouchableOpacity>

                        <View style={styles.quickChoices}>
                            {[
                                { id: 'ride', icon: Car, label: 'Viagem', color: '#FDF2F5' },
                                { id: 'delivery', icon: Package, label: 'Entrega', color: '#EFF6FF' }
                            ].map(item => (
                                <TouchableOpacity
                                    key={item.id}
                                    style={[styles.choiceBtn, { backgroundColor: item.color }]}
                                    onPress={() => handleCategorySelect(item.id)}
                                >
                                    <item.icon size={32} color={item.id === 'ride' ? colors.primary : colors.secondary} />
                                    <Text style={styles.choiceLabel}>{item.label}</Text>
                                </TouchableOpacity>
                            ))}
                        </View>
                    </View>
                );

            case 'requesting':
                return (
                    <View style={styles.overlay}>
                        <View style={styles.radarContainer}>
                            <Animated.View
                                style={[
                                    styles.radarRing,
                                    {
                                        transform: [{ scale: radarAnim.interpolate({ inputRange: [0, 1], outputRange: [1, 2.5] }) }],
                                        opacity: radarAnim.interpolate({ inputRange: [0, 1], outputRange: [0.8, 0] })
                                    }
                                ]}
                            />
                            <Navigation size={40} color="#FFF" />
                        </View>
                        <Text style={styles.overlayTitle}>Procurando motorista...</Text>
                        <Text style={styles.overlaySub}>Estamos conectando você aos melhores da TOT</Text>
                        <TouchableOpacity style={styles.cancelBtn} onPress={handleCancelRide}>
                            <Text style={styles.cancelText}>Cancelar Pedido</Text>
                        </TouchableOpacity>
                    </View>
                );

            case 'accepted':
                return (
                    <View style={styles.bottomSheet}>
                        <View style={styles.driverCard}>
                            <View style={styles.driverInfo}>
                                <View style={styles.avatarBox}>
                                    <View style={styles.avatar} />
                                </View>
                                <View style={styles.driverDetails}>
                                    <Text style={styles.driverName}>{acceptedDriver?.name}</Text>
                                    <View style={styles.ratingRow}>
                                        <Star size={14} color="#F59E0B" fill="#F59E0B" />
                                        <Text style={styles.ratingText}>4.9 • Toyota Corolla</Text>
                                    </View>
                                </View>
                            </View>
                            <View style={styles.carBadge}>
                                <Text style={styles.plateNumber}>LD-45-67-AP</Text>
                            </View>
                        </View>
                        <TouchableOpacity style={styles.actionBtn}>
                            <Text style={styles.actionBtnText}>Enviar Mensagem</Text>
                        </TouchableOpacity>
                        <TouchableOpacity style={[styles.cancelBtnMinimal, { marginTop: 15 }]} onPress={handleCancelRide}>
                            <Text style={styles.cancelTextMinimalDark}>Cancelar Viagem</Text>
                        </TouchableOpacity>
                    </View>
                );

            case 'ongoing':
                return (
                    <View style={styles.bottomSheet}>
                        <View style={styles.ongoingHeader}>
                            <View style={styles.statusRow}>
                                <Shield size={16} color={colors.success} />
                                <Text style={styles.ongoingText}>Viagem Segura Ativada</Text>
                            </View>
                            <View style={styles.liveFareBadge}>
                                <Text style={styles.liveFareText}>Kz {currentFare.toLocaleString()}</Text>
                            </View>
                        </View>
                        <View style={styles.driverMinimalCard}>
                            <View style={styles.avatarBoxSmall}>
                                <View style={styles.avatarSmall} />
                            </View>
                            <View style={styles.driverMinimalDetails}>
                                <Text style={styles.driverNameSmall}>{acceptedDriver?.name}</Text>
                                <Text style={styles.driverCarSmall}>Toyota Corolla • LD-45-67-AP</Text>
                            </View>
                            <TouchableOpacity style={styles.chatIconBtn}>
                                <Smartphone size={20} color={colors.primary} />
                            </TouchableOpacity>
                        </View>
                        <View style={styles.progressPlaceholder}>
                            <View style={styles.progressBar}>
                                <Animated.View style={[styles.progressFill, {
                                    width: radarAnim.interpolate({
                                        inputRange: [0, 1],
                                        outputRange: ['40%', '85%']
                                    })
                                }]} />
                            </View>
                            <View style={styles.etaRow}>
                                <Clock size={14} color={colors.textSecondary} />
                                <Text style={styles.etaText}>Chegada em 8 min</Text>
                            </View>
                        </View>
                        <TouchableOpacity style={styles.cancelBtnMinimal} onPress={handleCancelRide}>
                            <Text style={styles.cancelTextMinimalDark}>Cancelar Viagem</Text>
                        </TouchableOpacity>
                    </View>
                );

            case 'waiting_payment':
                return (
                    <View style={styles.overlay}>
                        <View style={styles.paymentCard}>
                            <View style={styles.paymentIconBox}>
                                <CreditCard size={40} color={colors.primary} />
                            </View>
                            <Text style={styles.paymentTitle}>Pagamento Pendente</Text>
                            <Text style={styles.paymentSub}>Aguardando o motorista confirmar o recebimento do valor.</Text>

                            <View style={styles.finalFareBox}>
                                <Text style={styles.finalFareLabel}>Valor Total</Text>
                                <Text style={styles.finalFareValue}>Kz {currentFare.toLocaleString()}</Text>
                            </View>

                            <View style={styles.loadingSpinnerSmall}>
                                <Animated.View style={[styles.spinnerIcon, {
                                    transform: [{
                                        rotate: paymentAnim.interpolate({
                                            inputRange: [0, 1],
                                            outputRange: ['0deg', '360deg']
                                        })
                                    }]
                                }]}>
                                    <Clock size={20} color={colors.primary} />
                                </Animated.View>
                                <Text style={styles.waitingText}>Processando...</Text>
                            </View>
                        </View>
                        <TouchableOpacity style={styles.helpBtnMinimal}>
                            <Text style={styles.helpTextMinimal}>Precisa de ajuda?</Text>
                        </TouchableOpacity>
                    </View>
                );

            case 'finished':
                return (
                    <View style={styles.overlay}>
                        <View style={styles.successIcon}>
                            <CheckCircle size={80} color={colors.success} />
                        </View>
                        <Text style={styles.overlayTitle}>Viagem Concluída!</Text>
                        <Text style={styles.overlaySub}>O valor final foi de Kz {currentFare.toLocaleString()}</Text>
                        <TouchableOpacity style={styles.primaryBtn} onPress={resetFlow}>
                            <Text style={styles.primaryBtnText}>Concluído</Text>
                        </TouchableOpacity>
                    </View>
                );

            case 'searching_address':
                return (
                    <View style={styles.searchContainer}>
                        <SafeAreaView style={{ backgroundColor: '#FFF' }}>
                            <View style={styles.searchHeader}>
                                <TouchableOpacity onPress={() => setStep('home')} style={styles.closeBtn}>
                                    <X size={28} color={colors.text} />
                                </TouchableOpacity>
                                <Text style={styles.headerTitlePink}>PARA ONDE VAIS?</Text>
                                <View style={{ width: 28 }} />
                            </View>

                            <View style={styles.inputsWrapper}>
                                <View style={styles.timelineContainer}>
                                    <View style={styles.blueDot} />
                                    <View style={styles.dottedLine} />
                                    <View style={styles.pinkDot} />
                                </View>
                                <View style={styles.inputsColumn}>
                                    <View style={styles.inputBox}>
                                        <Text style={styles.inputTextStatic}>{pickupAddress}</Text>
                                    </View>
                                    <View style={styles.inputDivider} />
                                    <View style={styles.inputBoxActive}>
                                        <TextInput
                                            style={styles.inputTextActive}
                                            placeholder="Para onde vais?"
                                            placeholderTextColor={colors.textSecondary}
                                            value={searchQuery}
                                            onChangeText={setSearchQuery}
                                            autoFocus
                                        />
                                        {searchQuery.length > 0 && (
                                            <TouchableOpacity onPress={() => setSearchQuery('')}>
                                                <X size={18} color={colors.primary} />
                                            </TouchableOpacity>
                                        )}
                                    </View>
                                </View>
                            </View>
                        </SafeAreaView>

                        <ScrollView style={styles.resultsList} showsVerticalScrollIndicator={false}>
                            {searchResults.map((item) => (
                                <TouchableOpacity
                                    key={item.id}
                                    style={styles.resultItem}
                                    onPress={() => handleSelectDestination(item)}
                                >
                                    <View style={styles.resultIconBox}>
                                        <MapPin size={24} color={colors.primary} />
                                    </View>
                                    <View style={styles.resultInfo}>
                                        <Text style={styles.resultName}>{item.name}</Text>
                                        <Text style={styles.resultAddress}>{item.address}</Text>
                                    </View>
                                    <Heart size={20} color="#E2E8F0" />
                                </TouchableOpacity>
                            ))}

                            <TouchableOpacity style={styles.resultItem} onPress={() => setStep('home')}>
                                <View style={styles.resultIconBox}>
                                    <MapPin size={24} color={colors.primary} />
                                </View>
                                <View style={styles.resultInfo}>
                                    <Text style={styles.resultName}>Definir no mapa</Text>
                                    <Text style={styles.resultAddress}>Escolher localização manualmente</Text>
                                </View>
                            </TouchableOpacity>
                        </ScrollView>
                    </View>
                );

            case 'service_selection':
                return (
                    <View style={styles.bottomSheet}>
                        <View style={styles.handleBar} />

                        <View style={styles.selectionHeader}>
                            <Text style={styles.sheetTitleCallback}>SELECIONE UMA OFERTA</Text>
                            <TouchableOpacity onPress={() => setStep('home')} style={styles.backBtn}>
                                <ArrowLeft size={20} color={colors.primary} />
                            </TouchableOpacity>
                        </View>

                        {calculatedServices.map((service) => {
                            // Dynamic Icon Logic based on DB vehicle_category (moto, car, van, truck)
                            const vc = (service.vehicle_category || '').toLowerCase();
                            let ServiceIcon = Car;
                            let vehicleLabel = 'Carro';

                            if (vc.includes('moto') || vc.includes('bike')) {
                                ServiceIcon = Bike;
                                vehicleLabel = 'Mota';
                            } else if (vc.includes('van') || vc.includes('carrinha') || vc.includes('truck')) {
                                ServiceIcon = Truck;
                                vehicleLabel = 'Carrinha';
                            }

                            return (
                                <TouchableOpacity
                                    key={service.id}
                                    style={[styles.serviceItem, selectedService?.id === service.id && styles.serviceItemActive]}
                                    onPress={() => handleServiceSelect(service)}
                                >
                                    <View style={styles.serviceLeft}>
                                        <View style={styles.serviceIconBox}>
                                            <ServiceIcon size={32} color={colors.text} />
                                        </View>
                                        <View>
                                            <View style={{ flexDirection: 'row', alignItems: 'center', gap: 5 }}>
                                                <Text style={styles.serviceName}>{service.name}</Text>
                                                <User size={12} color={colors.textSecondary} />
                                                <Text style={styles.serviceCapacity}>4</Text>
                                            </View>
                                            <Text style={styles.serviceType}>{vehicleLabel}</Text>
                                        </View>
                                    </View>
                                    <Text style={styles.servicePrice}>{service.estimatedPrice.toLocaleString()} Kz</Text>
                                </TouchableOpacity>
                            );
                        })}

                        <TouchableOpacity
                            style={[
                                styles.primaryBtn,
                                !selectedService
                                    ? { backgroundColor: '#E2E8F0' } // Disabled / Default
                                    : { backgroundColor: colors.primary } // Selected (Pink)
                            ]}
                            onPress={handleRequestTrip}
                            disabled={!selectedService}
                        >
                            <Text style={[
                                styles.primaryBtnText,
                                !selectedService
                                    ? { color: '#94A3B8' } // Disabled Text
                                    : { color: '#FFF' } // Selected Text (White)
                            ]}>Continuar</Text>
                        </TouchableOpacity>
                    </View>
                );

            default:
                return null;
        }
    };

    return (
        <SafeAreaView style={styles.container}>
            <StatusBar barStyle="dark-content" backgroundColor="#FFF" />
            <View style={styles.mapPlaceholder}>
                <Image
                    source={{ uri: 'https://api.mapbox.com/styles/v1/mapbox/light-v10/static/-8.839,13.289,14/800x800?access_token=YOUR_TOKEN' }}
                    style={StyleSheet.absoluteFill}
                />
            </View>

            {renderHeader()}
            {renderStepContent()}
        </SafeAreaView>
    );
}

const styles = StyleSheet.create({
    container: {
        flex: 1,
        backgroundColor: '#FFF',
    },
    mapPlaceholder: {
        flex: 1,
        backgroundColor: '#F1F5F9',
    },
    headerFloating: {
        position: 'absolute',
        top: 50,
        left: 20,
        right: 20,
        flexDirection: 'row',
        justifyContent: 'space-between',
        alignItems: 'center',
    },
    iconCircle: {
        width: 50,
        height: 50,
        borderRadius: 25,
        backgroundColor: '#FFF',
        justifyContent: 'center',
        alignItems: 'center',
        ...colors.shadow,
    },
    userInfo: {
        alignItems: 'center',
    },
    welcomeText: {
        fontSize: 16,
        fontWeight: '900',
        color: colors.text,
    },
    locationLabel: {
        fontSize: 12,
        color: colors.primary,
        fontWeight: '700',
    },
    bottomSheet: {
        backgroundColor: '#FFF',
        borderTopLeftRadius: 32,
        borderTopRightRadius: 32,
        padding: 30,
        ...colors.shadow,
    },
    sheetTitle: {
        fontSize: 22,
        fontWeight: '900',
        color: colors.text,
        marginBottom: 20,
    },
    searchBar: {
        height: 60,
        backgroundColor: '#F8FAFC',
        borderRadius: 20,
        flexDirection: 'row',
        alignItems: 'center',
        paddingHorizontal: 20,
        borderWidth: 1.5,
        borderColor: '#F1F5F9',
        marginBottom: 25,
    },
    searchText: {
        marginLeft: 12,
        fontSize: 15,
        color: colors.textSecondary,
        fontWeight: '600',
    },
    quickChoices: {
        flexDirection: 'row',
        justifyContent: 'space-between',
        marginBottom: 10,
    },
    choiceBtn: {
        width: (width - 80) / 2,
        height: 120,
        borderRadius: 24,
        justifyContent: 'center',
        alignItems: 'center',
    },
    choiceLabel: {
        marginTop: 10,
        fontSize: 16,
        fontWeight: '800',
        color: colors.text,
    },
    fabRequest: {
        position: 'absolute',
        bottom: 240,
        right: 20,
        width: 64,
        height: 64,
        borderRadius: 32,
        backgroundColor: colors.primary,
        justifyContent: 'center',
        alignItems: 'center',
        ...colors.shadow,
        shadowColor: colors.primary,
    },
    overlay: {
        ...StyleSheet.absoluteFillObject,
        backgroundColor: 'rgba(233, 30, 99, 0.95)',
        justifyContent: 'center',
        alignItems: 'center',
        padding: 30,
    },
    radarContainer: {
        width: 120,
        height: 120,
        borderRadius: 60,
        backgroundColor: 'rgba(255,255,255,0.2)',
        justifyContent: 'center',
        alignItems: 'center',
        marginBottom: 30,
    },
    radarRing: {
        position: 'absolute',
        width: 140,
        height: 140,
        borderRadius: 70,
        borderWidth: 2,
        borderColor: 'rgba(255,255,255,0.3)',
    },
    overlayTitle: {
        fontSize: 28,
        fontWeight: '950',
        color: '#FFF',
        textAlign: 'center',
        marginBottom: 10,
    },
    overlaySub: {
        fontSize: 16,
        color: 'rgba(255,255,255,0.8)',
        textAlign: 'center',
        marginBottom: 40,
    },
    cancelText: {
        color: '#FFF',
        fontWeight: '800',
    },
    cancelBtnMinimal: {
        paddingVertical: 10,
        alignItems: 'center',
        justifyContent: 'center',
    },
    cancelTextMinimalDark: {
        color: colors.textSecondary,
        fontSize: 14,
        fontWeight: '700',
        textDecorationLine: 'underline',
    },
    driverCard: {
        flexDirection: 'row',
        justifyContent: 'space-between',
        alignItems: 'center',
        marginBottom: 25,
    },
    driverInfo: {
        flexDirection: 'row',
        alignItems: 'center',
    },
    avatarBox: {
        width: 60,
        height: 60,
        borderRadius: 24,
        backgroundColor: '#F1F5F9',
        overflow: 'hidden',
    },
    avatar: {
        width: '100%',
        height: '100%',
        backgroundColor: colors.border,
    },
    driverDetails: {
        marginLeft: 15,
    },
    driverName: {
        fontSize: 18,
        fontWeight: '900',
        color: colors.text,
    },
    ratingRow: {
        flexDirection: 'row',
        alignItems: 'center',
        gap: 4,
        marginTop: 4,
    },
    ratingText: {
        fontSize: 13,
        color: colors.textSecondary,
        fontWeight: '600',
    },
    carBadge: {
        backgroundColor: '#F1F5F9',
        paddingHorizontal: 12,
        paddingVertical: 8,
        borderRadius: 12,
    },
    plateNumber: {
        fontSize: 14,
        fontWeight: '800',
        color: colors.text,
    },
    actionBtn: {
        backgroundColor: colors.primary,
        height: 60,
        borderRadius: 20,
        justifyContent: 'center',
        alignItems: 'center',
    },
    actionBtnText: {
        color: '#FFF',
        fontSize: 18,
        fontWeight: '800',
    },
    ongoingHeader: {
        flexDirection: 'row',
        alignItems: 'center',
        justifyContent: 'center',
        gap: 8,
        marginBottom: 25,
    },
    ongoingText: {
        fontSize: 15,
        fontWeight: '900',
        color: colors.success,
    },
    fareRow: {
        alignItems: 'center',
        marginBottom: 25,
    },
    fareLabel: {
        fontSize: 12,
        fontWeight: '800',
        color: colors.textSecondary,
        textTransform: 'uppercase',
    },
    fareValue: {
        fontSize: 36,
        fontWeight: '950',
        color: colors.text,
        marginTop: 5,
    },
    progressPlaceholder: {
        marginBottom: 10,
    },
    progressBar: {
        height: 8,
        backgroundColor: '#F1F5F9',
        borderRadius: 4,
        overflow: 'hidden',
    },
    progressFill: {
        height: '100%',
        backgroundColor: colors.primary,
    },
    etaText: {
        textAlign: 'center',
        marginTop: 10,
        fontSize: 13,
        fontWeight: '700',
        color: colors.textSecondary,
    },
    successIcon: {
        marginBottom: 30,
    },
    primaryBtn: {
        backgroundColor: '#FFF',
        width: '100%',
        height: 60,
        borderRadius: 20,
        justifyContent: 'center',
        alignItems: 'center',
        marginTop: 20,
    },
    primaryBtnText: {
        color: colors.primary,
        fontSize: 18,
        fontWeight: '900',
    },
    // Search Screen Styles
    searchContainer: {
        ...StyleSheet.absoluteFillObject,
        backgroundColor: '#FFF',
        zIndex: 100,
    },
    searchHeader: {
        flexDirection: 'row',
        alignItems: 'center',
        justifyContent: 'space-between',
        paddingHorizontal: 20,
        paddingVertical: 15,
        borderBottomWidth: 1,
        borderBottomColor: '#F8FAFC',
    },
    closeBtn: {
        padding: 5,
    },
    headerTitlePink: {
        fontSize: 16,
        fontWeight: '900',
        color: colors.primary,
        textTransform: 'uppercase',
    },
    inputsWrapper: {
        flexDirection: 'row',
        padding: 20,
        backgroundColor: '#FFF',
        ...colors.shadow,
        paddingBottom: 25,
    },
    timelineContainer: {
        alignItems: 'center',
        marginRight: 15,
        paddingVertical: 12,
    },
    blueDot: {
        width: 10,
        height: 10,
        borderRadius: 5,
        backgroundColor: '#3B82F6',
    },
    dottedLine: {
        flex: 1,
        width: 1,
        backgroundColor: '#E2E8F0',
        marginVertical: 4,
    },
    pinkDot: {
        width: 10,
        height: 10,
        borderRadius: 5,
        backgroundColor: colors.primary,
        borderWidth: 2,
        borderColor: colors.primary,
    },
    inputsColumn: {
        flex: 1,
    },
    inputBox: {
        height: 44,
        justifyContent: 'center',
        borderBottomWidth: 1,
        borderBottomColor: '#F1F5F9',
        marginBottom: 4,
    },
    inputBoxActive: {
        height: 44,
        flexDirection: 'row',
        alignItems: 'center',
        justifyContent: 'space-between',
        backgroundColor: '#FDF2F5',
        borderRadius: 8,
        paddingHorizontal: 10,
        marginTop: 4,
    },
    inputTextStatic: {
        fontSize: 15,
        fontWeight: '600',
        color: colors.text,
    },
    inputTextActive: {
        fontSize: 16,
        fontWeight: '700',
        color: colors.text,
    },
    inputDivider: {
        height: 1,
    },
    resultsList: {
        flex: 1,
        backgroundColor: '#FFF',
        paddingHorizontal: 20,
        paddingTop: 10,
    },
    resultItem: {
        flexDirection: 'row',
        alignItems: 'center',
        paddingVertical: 16,
        borderBottomWidth: 1,
        borderBottomColor: '#F8FAFC',
    },
    resultIconBox: {
        width: 40,
        height: 40,
        borderRadius: 20,
        backgroundColor: '#FDF2F5',
        justifyContent: 'center',
        alignItems: 'center',
        marginRight: 15,
    },
    resultInfo: {
        flex: 1,
    },
    resultName: {
        fontSize: 16,
        fontWeight: '800',
        color: colors.text,
        marginBottom: 2,
    },
    resultAddress: {
        fontSize: 13,
        color: colors.textSecondary,
        fontWeight: '500',
    },
    resultAddress: {
        fontSize: 13,
        color: colors.textSecondary,
        fontWeight: '500',
    },
    // Service Selection Styles
    handleBar: {
        width: 40,
        height: 5,
        backgroundColor: '#E2E8F0',
        borderRadius: 2.5,
        alignSelf: 'center',
        marginBottom: 20,
    },
    sheetTitleCallback: {
        fontSize: 16,
        fontWeight: '900',
        color: colors.primary,
        textTransform: 'uppercase',
    },
    selectionHeader: {
        flexDirection: 'row',
        justifyContent: 'space-between',
        alignItems: 'center',
        marginBottom: 20,
    },
    backBtn: {
        width: 36,
        height: 36,
        borderRadius: 18,
        backgroundColor: '#FDF2F5', // Light Pink
        justifyContent: 'center',
        alignItems: 'center',
    },
    serviceItem: {
        flexDirection: 'row',
        alignItems: 'center',
        justifyContent: 'space-between',
        padding: 15,
        borderRadius: 20,
        backgroundColor: '#F8FAFC',
        marginBottom: 10,
        borderWidth: 2,
        borderColor: 'transparent',
    },
    serviceItemActive: {
        backgroundColor: '#FDF2F5',
        borderColor: colors.primary,
    },
    serviceLeft: {
        flexDirection: 'row',
        alignItems: 'center',
    },
    serviceIconBox: {
        marginRight: 15,
    },
    serviceName: {
        fontSize: 16,
        fontWeight: '900',
        color: colors.text,
    },
    serviceCapacity: {
        fontSize: 12,
        fontWeight: '600',
        color: colors.textSecondary,
    },
    serviceType: {
        fontSize: 12,
        color: colors.textSecondary,
        marginTop: 2,
    },
    servicePrice: {
        fontSize: 18,
        fontWeight: '950',
        color: colors.text,
    },
    searchBarActive: {
        borderColor: colors.primary, // Highlight input when destination is set
        backgroundColor: '#FFF',
    },
    destinationDot: {
        width: 10,
        height: 10,
        borderRadius: 5,
        backgroundColor: colors.primary,
        marginRight: 12,
    },
    searchTextActive: {
        fontSize: 16,
        fontWeight: '700',
        color: colors.text,
    },
    // Enhanced Ongoing & Payment Styles
    statusRow: {
        flexDirection: 'row',
        alignItems: 'center',
        gap: 6,
    },
    liveFareBadge: {
        backgroundColor: '#FDF2F5',
        paddingHorizontal: 12,
        paddingVertical: 6,
        borderRadius: 12,
    },
    liveFareText: {
        fontSize: 14,
        fontWeight: '900',
        color: colors.primary,
    },
    driverMinimalCard: {
        flexDirection: 'row',
        alignItems: 'center',
        backgroundColor: '#F8FAFC',
        padding: 15,
        borderRadius: 20,
        marginBottom: 20,
    },
    avatarBoxSmall: {
        width: 44,
        height: 44,
        borderRadius: 18,
        backgroundColor: '#E2E8F0',
        overflow: 'hidden',
    },
    avatarSmall: {
        width: '100%',
        height: '100%',
        backgroundColor: colors.border,
    },
    driverMinimalDetails: {
        flex: 1,
        marginLeft: 12,
    },
    driverNameSmall: {
        fontSize: 15,
        fontWeight: '900',
        color: colors.text,
    },
    driverCarSmall: {
        fontSize: 12,
        color: colors.textSecondary,
        fontWeight: '600',
        marginTop: 2,
    },
    chatIconBtn: {
        width: 40,
        height: 40,
        borderRadius: 20,
        backgroundColor: '#FFF',
        justifyContent: 'center',
        alignItems: 'center',
        ...colors.shadow,
    },
    etaRow: {
        flexDirection: 'row',
        alignItems: 'center',
        justifyContent: 'center',
        gap: 6,
        marginTop: 10,
    },
    paymentCard: {
        backgroundColor: '#FFF',
        width: '100%',
        borderRadius: 32,
        padding: 30,
        alignItems: 'center',
        ...colors.shadow,
    },
    paymentIconBox: {
        width: 80,
        height: 80,
        borderRadius: 40,
        backgroundColor: '#FDF2F5',
        justifyContent: 'center',
        alignItems: 'center',
        marginBottom: 20,
    },
    paymentTitle: {
        fontSize: 22,
        fontWeight: '900',
        color: colors.text,
        marginBottom: 10,
    },
    paymentSub: {
        fontSize: 14,
        color: colors.textSecondary,
        textAlign: 'center',
        fontWeight: '600',
        lineHeight: 20,
        marginBottom: 25,
    },
    finalFareBox: {
        backgroundColor: '#F8FAFC',
        width: '100%',
        padding: 20,
        borderRadius: 20,
        alignItems: 'center',
        marginBottom: 25,
    },
    finalFareLabel: {
        fontSize: 12,
        fontWeight: '800',
        color: colors.textSecondary,
        textTransform: 'uppercase',
    },
    finalFareValue: {
        fontSize: 30,
        fontWeight: '950',
        color: colors.text,
        marginTop: 5,
    },
    loadingSpinnerSmall: {
        flexDirection: 'row',
        alignItems: 'center',
        gap: 10,
    },
    spinnerIcon: {
        // Handled by animation transform
    },
    waitingText: {
        fontSize: 14,
        fontWeight: '800',
        color: colors.primary,
    },
    helpBtnMinimal: {
        marginTop: 30,
    },
    helpTextMinimal: {
        color: 'rgba(255,255,255,0.8)',
        fontSize: 14,
        fontWeight: '700',
        textDecorationLine: 'underline',
    }
});

import React, { useState, useEffect, useRef } from 'react';
import {
    View,
    Text,
    StyleSheet,
    TouchableOpacity,
    SafeAreaView,
    StatusBar,
    Animated,
    Dimensions,
    Image,
    ScrollView,
    TextInput,
    Platform,
    Alert,
    BackHandler
} from 'react-native';
import AsyncStorage from '@react-native-async-storage/async-storage';
import Geolocation from 'react-native-geolocation-service';
import {
    Menu,
    Search,
    Navigation,
    MapPin,
    Clock,
    Package,
    Bike,
    Car,
    Truck,
    Star,
    Shield,
    CheckCircle,
    X,
    Heart,
    User,
    ArrowLeft,
    Smartphone,
    CreditCard
} from 'lucide-react-native';
import colors from '../theme/colors';
import socket from '../services/socket';
import api from '../services/api';
import hereService from '../services/hereService';
import hereRoutingService from '../services/hereRoutingService';
import HereMap from '../components/HereMap';
import { useAuth } from '../context/AuthContext';
import Toast from 'react-native-toast-message';

const { width, height } = Dimensions.get('window');

export default function RideFlowScreen({ navigation, route }) {
    const { user } = useAuth();
    // Default to 'searching_address' if opened from Search Input, or 'home' otherwise
    const [step, setStep] = useState(route.params?.initialStep || 'home');
    const [loading, setLoading] = useState(false);
    const [destination, setDestination] = useState(null);
    const [pickupAddress, setPickupAddress] = useState('Obtendo localizaÃ§Ã£o...');
    const [pickupCoords, setPickupCoords] = useState(route.params?.pickupCoords || { lat: -8.839, lng: 13.289 });
    const [selectedService, setSelectedService] = useState(null);
    const [availableServices, setAvailableServices] = useState([]);
    const [calculatedServices, setCalculatedServices] = useState([]);
    const [tripId, setTripId] = useState(null);
    const [acceptedDriver, setAcceptedDriver] = useState(null);
    const [currentFare, setCurrentFare] = useState(0);
    const [searchQuery, setSearchQuery] = useState('');
    const [searchResults, setSearchResults] = useState([]);
    const [mapReady, setMapReady] = useState(false);

    const mapRef = useRef(null);
    const radarAnim = useRef(new Animated.Value(0)).current;
    const paymentAnim = useRef(new Animated.Value(0)).current;

    // --- Effects ---

    // 0. Update pickup from params if provided (e.g. passed from Dashboard)
    useEffect(() => {
        if (route.params?.pickupCoords) {
            setPickupCoords(route.params.pickupCoords);
            if (mapReady && mapRef.current) {
                mapRef.current.setUserLocation(route.params.pickupCoords);
            }
        }
        if (route.params?.pickupAddress) setPickupAddress(route.params.pickupAddress);
    }, [route.params]);

    // 1. Initial GPS (Backup if not passed) & Service Load
    useEffect(() => {
        loadServices();
        if (!route.params?.pickupCoords) {
            Geolocation.getCurrentPosition(
                async (pos) => {
                    const coords = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                    setPickupCoords(coords);
                    const addr = await hereService.reverseGeocode(coords.lat, coords.lng);
                    if (addr) setPickupAddress(addr);
                },
                (err) => console.log('GPS Error:', err),
                { enableHighAccuracy: true }
            );
        }

        // Resume check
        checkActiveRide();
    }, []);

    const checkActiveRide = async () => {
        const saved = await AsyncStorage.getItem('active_ride_state');
        if (saved) {
            const data = JSON.parse(saved);
            if (data.tripId) {
                setTripId(data.tripId);
                setStep(data.status);
                setDestination(data.destination);
                if (data.driver) setAcceptedDriver(data.driver);
            }
        }
    };

    // 2. State Persistence
    useEffect(() => {
        if (tripId) {
            AsyncStorage.setItem('active_ride_state', JSON.stringify({
                tripId, status: step, destination, driver: acceptedDriver, timestamp: Date.now()
            }));
        } else if (step === 'home') {
            AsyncStorage.removeItem('active_ride_state');
        }
    }, [tripId, step, destination, acceptedDriver]);

    // 3. Search Logic
    useEffect(() => {
        const delay = setTimeout(async () => {
            if (searchQuery.length >= 3) {
                const results = await hereService.fetchSuggestions(searchQuery, pickupCoords);
                setSearchResults(results);
            } else {
                setSearchResults([]);
            }
        }, 500);
        return () => clearTimeout(delay);
    }, [searchQuery]);

    // 4. Animation Loops
    useEffect(() => {
        if (step === 'requesting') {
            Animated.loop(
                Animated.sequence([
                    Animated.timing(radarAnim, { toValue: 1, duration: 1500, useNativeDriver: false }),
                    Animated.timing(radarAnim, { toValue: 0, duration: 0, useNativeDriver: false })
                ])
            ).start();
        } else {
            radarAnim.setValue(0);
        }

        if (step === 'waiting_payment') {
            Animated.loop(
                Animated.timing(paymentAnim, { toValue: 1, duration: 4000, useNativeDriver: false }) // Slower rotation
            ).start();
        } else {
            paymentAnim.setValue(0);
        }
    }, [step]);

    // 5. Back Handler (With Safety Valve)
    const lastBackPress = useRef(0);
    useEffect(() => {
        const backAction = () => {
            const now = Date.now();
            if (['requesting', 'accepted', 'ongoing', 'payment'].includes(step)) {
                // Safety Valve: Double press to force exit
                if (now - lastBackPress.current < 2000) {
                    resetFlow();
                    // Force navigation back to Dashboard
                    navigation.reset({
                        index: 0,
                        routes: [{ name: 'App', params: { screen: 'Dashboard' } }],
                    });
                    return true;
                }

                lastBackPress.current = now;
                Toast.show({
                    type: 'info',
                    text1: 'AtenÃ§Ã£o',
                    text2: 'Pressione novamente para sair forÃ§adamente (apenas se travado)'
                });
                return true; // Block single press
            }

            if (step === 'searching_address' || step === 'service_selection') {
                setStep('home');
                return true;
            }

            // If at home, go back to Dashboard
            navigation.navigate('App', { screen: 'Dashboard' });
            return true;
        };
        const backHandler = BackHandler.addEventListener("hardwareBackPress", backAction);
        return () => backHandler.remove();
    }, [step]);

    // --- Socket Listeners (The Vault Logic) ---
    useEffect(() => {
        const onConnect = () => socket.emit('join', { userId: user.id, role: 'client' });

        // Safety Check: If we join and server says "no active trip", we should probably reset?
        // But for now, let's rely on the Force Exit.

        const onTripCreated = (data) => {
            setTripId(data.tripId);
            setStep('requesting');
        };

        const onTripAccepted = (data) => {
            setAcceptedDriver(data.driver);
            setStep('accepted');
            if (mapReady) mapRef.current?.setDriverPosition({ lat: data.driver.lat, lng: data.driver.lng });
        };

        const onRideStarted = () => setStep('ongoing');

        const onTripUpdate = (data) => {
            if (data.currentFare) setCurrentFare(data.currentFare);
            if (data.driverLat && data.driverLng) {
                mapRef.current?.setDriverPosition({ lat: data.driverLat, lng: data.driverLng });
            }
        };

        const onRideFinished = (data) => {
            setStep('waiting_payment');
            setCurrentFare(data.finalFare);
            mapRef.current?.clearMap();
            mapRef.current?.setUserLocation(pickupCoords);
        };

        const onPaymentConfirmed = (data) => {
            setStep('finished');
            if (data.finalFare) setCurrentFare(data.finalFare);
        };

        const onTripCancelled = () => {
            resetFlow();
            Toast.show({ type: 'info', text1: 'Cancelado', text2: 'A viagem foi cancelada.' });
        };

        // Handle "Trip Not Found" error from server (important for phantom rides)
        const onTripError = (data) => {
            console.log('Trip Error:', data);
            if (data.message && (data.message.includes('not found') || data.message.includes('found'))) {
                // specific check for "Trip not found"
                // But safest to just show error.
            }
            // If we are stuck in requesting and get an error, maybe we should stop?
        };

        socket.on('connect', onConnect);
        socket.on('trip_created', onTripCreated);
        socket.on('trip_accepted', onTripAccepted);
        socket.on('ride_started', onRideStarted);
        socket.on('trip_update', onTripUpdate);
        socket.on('ride_finished', onRideFinished);
        socket.on('payment_confirmed', onPaymentConfirmed);
        socket.on('trip_cancelled', onTripCancelled);
        socket.on('trip_timeout', onTripCancelled);
        socket.on('trip_error', onTripError);

        return () => {
            socket.off('connect', onConnect);
            socket.off('trip_created', onTripCreated);
            socket.off('trip_accepted', onTripAccepted);
            socket.off('ride_started', onRideStarted);
            socket.off('trip_update', onTripUpdate);
            socket.off('ride_finished', onRideFinished);
            socket.off('payment_confirmed', onPaymentConfirmed);
            socket.off('trip_cancelled', onTripCancelled);
            socket.off('trip_timeout', onTripCancelled);
            socket.off('trip_error', onTripError);
        };
    }, [tripId, pickupCoords, mapReady]);


    // --- Helper Functions ---

    const loadServices = async () => {
        try {
            const res = await api.getServices();
            setAvailableServices(res.data);
        } catch (e) {
            console.error(e);
        }
    };

    const calculateFares = async (destLat, destLng) => {
        if (!pickupCoords) return;
        const route = await hereRoutingService.getRoute(pickupCoords, { lat: destLat, lng: destLng });

        if (route) {
            mapRef.current?.drawRoute(route.rawPolyline || route.geometry);
            const distKm = parseFloat(route.distanceKm);
            const durMin = route.durationMin;

            const calculated = availableServices
                .filter(s => s.category === 'ride') // Only rides here
                .map(service => {
                    const base = parseFloat(service.base_fare || 0);
                    const pKm = parseFloat(service.price_per_km || 0);
                    const pMin = parseFloat(service.price_per_min || 0);
                    const minFare = parseFloat(service.min_fare || 0);
                    let total = base + (distKm * pKm) + (durMin * pMin);
                    total = Math.max(total, minFare);
                    return { ...service, estimatedPrice: Math.round(total), estimatedTime: Math.ceil(durMin) };
                });
            setCalculatedServices(calculated);
        }
    };

    const handleSelectDestination = (item) => {
        setDestination(item);
        setSearchQuery(item.address || item.name);
        setStep('home'); // Go back to map view (home state of this screen)

        // Sync Map
        if (mapRef.current && pickupCoords) {
            const dest = { lat: item.lat, lng: item.lng };
            mapRef.current.setMarkers(pickupCoords, dest);
            calculateFares(item.lat, item.lng);
        }
    };

    const onMapTap = async (coords) => {
        if (step !== 'home' && step !== 'searching_address') return;

        const address = await hereService.reverseGeocode(coords.lat, coords.lng);
        const item = {
            name: address ? address.split(',')[0] : 'Local Selecionado',
            address: address || 'Coordenadas do mapa',
            lat: coords.lat,
            lng: coords.lng
        };

        handleSelectDestination(item);
    };

    const handleProceedToSelection = () => {
        if (!destination) {
            Toast.show({ type: 'error', text1: 'Destino', text2: 'Selecione um destino primeiro.' });
            return;
        }
        if (calculatedServices.length === 0) {
            // Try calc again
            calculateFares(destination.lat, destination.lng);
        }
        setStep('service_selection');
    };

    const handleRequestTrip = () => {
        if (loading) return; // Debounce

        try {
            console.log('ðŸ”µ [RideFlow] BotÃ£o CONTINUAR clicado. Iniciando handleRequestTrip...');

            if (!selectedService || !destination) {
                Toast.show({ type: 'error', text1: 'Erro', text2: 'Selecione o destino e o serviÃ§o primeiro.' });
                return;
            }

            setLoading(true); // Block further clicks

            // Check Socket Connection
            if (!socket.connected) {
                console.log('ðŸ“¡ [RideFlow] Socket desconectado! Tentando reconectar...');
                socket.connect();
            }

            const payload = {
                clientId: user.id,
                userName: user.full_name,
                originAddress: pickupAddress,
                destAddress: destination.name,
                originLat: pickupCoords.lat,
                originLng: pickupCoords.lng,
                destLat: destination.lat,
                destLng: destination.lng,
                category: 'ride',
                price: Number(selectedService.estimatedPrice),
                estimatedFare: Number(selectedService.estimatedPrice),
                serviceConfigId: Number(selectedService.id), // Added from backup
                serviceId: Number(selectedService.id)
            };

            console.log('ðŸ”µ [RideFlow] Payload:', JSON.stringify(payload, null, 2));

            socket.emit('request_trip', payload);
            console.log('ðŸš€ [RideFlow] Evento request_trip emitido!');

            // Optimistic Update
            setStep('requesting');
            // We don't set loading(false) because the view changes. 
            // If we stay here due to error, catch block will handle it.

        } catch (error) {
            console.error('âŒ [RideFlow] ERRO FATAL:', error);
            Toast.show({ type: 'error', text1: 'Erro Fatal', text2: error.message });
            setLoading(false);
        }
    };

    const resetFlow = async () => {
        setStep('home');
        setTripId(null);
        setAcceptedDriver(null);
        setDestination(null);
        setCurrentFare(0);
        setLoading(false);
        await AsyncStorage.removeItem('active_ride_state');
        mapRef.current?.clearMap();
        mapRef.current?.setUserLocation(pickupCoords);
        console.log('ðŸ”„ [RideFlow] Fluxo resetado e cache limpo.');
    };

    const handleCancelTrip = () => {
        if (!tripId) {
            resetFlow();
            return;
        }
        console.log('ðŸš« [RideFlow] Cancelando viagem:', tripId);
        socket.emit('cancel_trip', { tripId, clientId: user.id });
        resetFlow();
        Toast.show({ type: 'info', text1: 'Cancelado', text2: 'Sua solicitaÃ§Ã£o foi cancelada.' });
    };


    // --- Renders ---

    const renderOverlay = () => {
        switch (step) {
            case 'home':
                // Small bottom sheet to trigger search
                return (
                    <View style={styles.bottomSheet}>
                        <Text style={styles.sheetTitle}>Para onde vamos hoje?</Text>
                        <TouchableOpacity style={[styles.searchBar, destination && styles.searchBarActive]} onPress={() => setStep('searching_address')}>
                            {!destination ? (
                                <>
                                    <MapPin size={20} color={colors.primary} />
                                    <Text style={styles.searchText}>Digite seu destino...</Text>
                                </>
                            ) : (
                                <>
                                    <View style={styles.destinationDot} />
                                    <Text style={styles.searchTextActive}>{destination.name}</Text>
                                    <TouchableOpacity style={{ marginLeft: 'auto' }} onPress={() => {
                                        setDestination(null);
                                        setSearchQuery('');
                                        mapRef.current?.clearMap();
                                    }}>
                                        <X size={18} color={colors.textSecondary} />
                                    </TouchableOpacity>
                                </>
                            )}
                        </TouchableOpacity>

                        {destination && (
                            <TouchableOpacity style={styles.primaryBtn} onPress={handleProceedToSelection}>
                                <Text style={styles.primaryBtnText}>Ver PreÃ§os</Text>
                            </TouchableOpacity>
                        )}
                        <TouchableOpacity style={{ marginTop: 15, alignSelf: 'center' }} onPress={resetFlow}>
                            <Text style={{ color: '#94A3B8', fontSize: 12 }}>Redefinir Estado (EmergÃªncia)</Text>
                        </TouchableOpacity>
                    </View>
                );

            case 'searching_address':
                return (
                    <View style={styles.searchContainer}>
                        <SafeAreaView style={{ backgroundColor: '#FFF' }}>
                            <View style={styles.searchHeader}>
                                <TouchableOpacity onPress={() => setStep('home')} style={styles.closeBtn}>
                                    <X size={28} color={colors.text} />
                                </TouchableOpacity>
                                <Text style={styles.headerTitlePink}>PARA ONDE VAIS?</Text>
                                <View style={{ width: 28 }} />
                            </View>

                            <View style={styles.inputsWrapper}>
                                <View style={styles.timelineContainer}>
                                    <View style={styles.blueDot} />
                                    <View style={styles.dottedLine} />
                                    <View style={styles.pinkDot} />
                                </View>
                                <View style={styles.inputsColumn}>
                                    <View style={styles.inputBox}>
                                        <Text style={styles.inputTextStatic}>{pickupAddress}</Text>
                                    </View>
                                    <View style={styles.inputDivider} />
                                    <View style={styles.inputBoxActive}>
                                        <TextInput
                                            style={styles.inputTextActive}
                                            placeholder="Para onde vais?"
                                            placeholderTextColor={colors.textSecondary}
                                            value={searchQuery}
                                            onChangeText={setSearchQuery}
                                            autoFocus
                                        />
                                        {searchQuery.length > 0 && (
                                            <TouchableOpacity onPress={() => setSearchQuery('')}>
                                                <X size={18} color={colors.primary} />
                                            </TouchableOpacity>
                                        )}
                                    </View>
                                </View>
                            </View>
                        </SafeAreaView>

                        <ScrollView style={styles.resultsList} showsVerticalScrollIndicator={false}>
                            {searchResults.map((item) => (
                                <TouchableOpacity key={item.id} style={styles.resultItem} onPress={() => handleSelectDestination(item)}>
                                    <View style={styles.resultIconBox}>
                                        <MapPin size={24} color={colors.primary} />
                                    </View>
                                    <View style={styles.resultInfo}>
                                        <Text style={styles.resultName}>{item.name}</Text>
                                        <Text style={styles.resultAddress}>{item.address}</Text>
                                    </View>
                                </TouchableOpacity>
                            ))}
                            <TouchableOpacity style={styles.resultItem} onPress={() => setStep('home')}>
                                <View style={styles.resultIconBox}>
                                    <MapPin size={24} color={colors.primary} />
                                </View>
                                <View style={styles.resultInfo}>
                                    <Text style={styles.resultName}>Definir no mapa</Text>
                                    <Text style={styles.resultAddress}>Toque no mapa para selecionar</Text>
                                </View>
                            </TouchableOpacity>
                        </ScrollView>
                    </View>
                );

            case 'service_selection':
                return (
                    <View style={styles.bottomSheet}>
                        <View style={styles.handleBar} />
                        <View style={styles.selectionHeader}>
                            <Text style={styles.sheetTitleCallback}>SELECIONE UMA VIAGEM</Text>
                            <TouchableOpacity onPress={() => setStep('home')} style={styles.backBtn}>
                                <ArrowLeft size={20} color={colors.primary} />
                            </TouchableOpacity>
                        </View>
                        {calculatedServices.map((service) => {
                            const vc = (service.vehicle_category || '').toLowerCase();
                            let ServiceIcon = Car;
                            if (vc.includes('moto')) ServiceIcon = Bike;
                            return (
                                <TouchableOpacity
                                    key={service.id}
                                    style={[styles.serviceItem, selectedService?.id === service.id && styles.serviceItemActive]}
                                    onPress={() => setSelectedService(service)}
                                >
                                    <View style={styles.serviceLeft}>
                                        <View style={styles.serviceIconBox}><ServiceIcon size={32} color={colors.text} /></View>
                                        <View>
                                            <Text style={styles.serviceName}>{service.name}</Text>
                                            <Text style={styles.serviceCapacity}>1-4 pessoas</Text>
                                        </View>
                                    </View>
                                    <Text style={styles.servicePrice}>{service.estimatedPrice.toLocaleString()} Kz</Text>
                                </TouchableOpacity>
                            );
                        })}
                        <TouchableOpacity
                            style={[styles.primaryBtn, { backgroundColor: (selectedService && !loading) ? colors.primary : '#E2E8F0' }]}
                            disabled={!selectedService || loading}
                            onPress={handleRequestTrip}
                        >
                            <Text style={[styles.primaryBtnText, { color: (selectedService && !loading) ? '#FFF' : '#94A3B8' }]}>
                                {loading ? 'Solicitando...' : 'Continuar'}
                            </Text>
                        </TouchableOpacity>
                    </View>
                );

            case 'requesting':
                return (
                    <View style={styles.overlay}>
                        <View style={styles.radarContainer}>
                            <Animated.View style={[styles.radarRing, {
                                transform: [{ scale: radarAnim.interpolate({ inputRange: [0, 1], outputRange: [1, 2.5] }) }],
                                opacity: radarAnim.interpolate({ inputRange: [0, 1], outputRange: [0.8, 0] })
                            }]} />
                            <Navigation size={40} color="#FFF" />
                        </View>
                        <Text style={styles.overlayTitle}>Procurando motorista...</Text>
                        <Text style={styles.overlaySub}>Estamos conectando vocÃª aos melhores da TOT</Text>
                        <TouchableOpacity style={styles.cancelBtn} onPress={handleCancelTrip}>
                            <Text style={styles.cancelText}>Cancelar Pedido</Text>
                        </TouchableOpacity>
                        <TouchableOpacity style={{ marginTop: 20 }} onPress={resetFlow}>
                            <Text style={{ color: 'rgba(255,255,255,0.6)', fontSize: 12 }}>Redefinir Estado (EmergÃªncia)</Text>
                        </TouchableOpacity>
                    </View>
                );

            case 'accepted':
                return (
                    <View style={styles.bottomSheet}>
                        <View style={styles.handleBar} />
                        <View style={styles.acceptedHeader}>
                            <View style={styles.driverAvatarLarge}>
                                <Text style={styles.avatarText}>{acceptedDriver?.name?.[0] || 'D'}</Text>
                            </View>
                            <Text style={styles.acceptedTitle}>Motorista a caminho!</Text>
                            <Text style={styles.acceptedSubtitle}>{acceptedDriver?.name} aceitou o seu pedido</Text>
                        </View>
                        <View style={styles.actionButtons}>
                            <TouchableOpacity style={styles.actionBtn}>
                                <Text style={styles.actionBtnText}>Mensagem</Text>
                            </TouchableOpacity>
                            <TouchableOpacity style={[styles.actionBtn, { backgroundColor: '#FEE2E2' }]} onPress={handleCancelTrip}>
                                <Text style={[styles.actionBtnText, { color: '#EF4444' }]}>Cancelar</Text>
                            </TouchableOpacity>
                        </View>
                        <TouchableOpacity style={{ marginTop: 15, alignSelf: 'center' }} onPress={resetFlow}>
                            <Text style={{ color: '#94A3B8', fontSize: 12 }}>Redefinir Estado (EmergÃªncia)</Text>
                        </TouchableOpacity>
                    </View>
                );

            case 'ongoing':
                return (
                    <View style={styles.bottomSheet}>
                        <View style={styles.handleBar} />
                        <View style={styles.ongoingHeader}>
                            <View style={styles.statusBadge}>
                                <Text style={styles.statusBadgeText}>VIAGEM EM CURSO</Text>
                            </View>
                            <Text style={styles.ongoingPrice}>{(currentFare || selectedService?.estimatedPrice || 0).toLocaleString()} Kz</Text>
                        </View>

                        <View style={styles.driverMinimalCard}>
                            <View style={styles.driverAvatarSmall}>
                                <Text style={styles.avatarTextSmall}>{acceptedDriver?.name?.[0] || 'D'}</Text>
                            </View>
                            <View style={styles.driverMinimalDetails}>
                                <Text style={styles.driverNameSmall}>{acceptedDriver?.name}</Text>
                                <Text style={styles.driverCarSmall}>Toyota Corolla â€¢ ABC-123-LD</Text>
                            </View>
                            <TouchableOpacity style={styles.chatIconBtn}>
                                <Smartphone size={20} color={colors.primary} />
                            </TouchableOpacity>
                        </View>

                        <View style={styles.progressPlaceholder}>
                            <View style={styles.progressBar}>
                                <Animated.View style={[styles.progressFill, { width: '60%' }]} />
                            </View>
                            <View style={styles.etaBox}>
                                <Clock size={16} color={colors.primary} />
                                <Text style={styles.etaText}>Chegada prevista em <Text style={{ fontWeight: '900', color: colors.primary }}>8 min</Text></Text>
                            </View>
                        </View>
                    </View>
                );

            case 'waiting_payment':
                return (
                    <View style={styles.overlay}>
                        <View style={styles.paymentCard}>
                            <View style={styles.paymentIconBox}>
                                <CreditCard size={40} color={colors.primary} />
                            </View>
                            <Text style={styles.paymentTitle}>Pagamento Pendente</Text>
                            <Text style={styles.paymentSub}>Aguardando o motorista confirmar o recebimento.</Text>

                            <View style={styles.finalFareBox}>
                                <Text style={styles.finalFareLabel}>Valor Total</Text>
                                <Text style={styles.finalFareValue}>Kz {currentFare.toLocaleString()}</Text>
                            </View>

                            <View style={styles.loadingSpinnerSmall}>
                                <Animated.View style={[styles.spinnerIcon, {
                                    transform: [{
                                        rotate: paymentAnim.interpolate({
                                            inputRange: [0, 1],
                                            outputRange: ['0deg', '360deg']
                                        })
                                    }]
                                }]}>
                                    <Clock size={20} color={colors.primary} />
                                </Animated.View>
                                <Text style={styles.waitingText}>Processando...</Text>
                            </View>
                        </View>
                        <TouchableOpacity style={{ marginTop: 30 }} onPress={resetFlow}>
                            <Text style={{ color: '#FFF', opacity: 0.7 }}>Redefinir Estado (EmergÃªncia)</Text>
                        </TouchableOpacity>
                    </View>
                );

            case 'finished':
                return (
                    <View style={styles.overlay}>
                        <View style={styles.successIcon}>
                            <CheckCircle size={80} color={colors.success} />
                        </View>
                        <Text style={styles.overlayTitle}>Viagem ConcluÃ­da!</Text>
                        <Text style={styles.overlaySub}>O valor final foi de Kz {currentFare.toLocaleString()}</Text>
                        <TouchableOpacity style={styles.primaryBtn} onPress={resetFlow}>
                            <Text style={styles.primaryBtnText}>ConcluÃ­do</Text>
                        </TouchableOpacity>
                    </View>
                );

            default: return null;
        }
    };

    return (
        <SafeAreaView style={styles.container}>
            <View style={styles.mapPlaceholder}>
                <HereMap ref={mapRef} onMapTap={onMapTap} />
            </View>
            {renderOverlay()}
        </SafeAreaView>
    );
}

// STYLES FROM BACKUP (Condensed for brevity but keeping all key visual props)
const styles = StyleSheet.create({
    container: { flex: 1, backgroundColor: '#FFF' },
    mapPlaceholder: { flex: 1, backgroundColor: '#F1F5F9' },
    bottomSheet: {
        backgroundColor: '#FFF',
        borderTopLeftRadius: 32,
        borderTopRightRadius: 32,
        padding: 30,
        ...colors.shadow,
        position: 'absolute',
        bottom: 0,
        width: '100%'
    },
    sheetTitle: {
        fontSize: 22,
        fontWeight: '900',
        color: colors.text,
        marginBottom: 20,
    },
    searchBar: {
        height: 60,
        backgroundColor: '#F8FAFC',
        borderRadius: 20,
        flexDirection: 'row',
        alignItems: 'center',
        paddingHorizontal: 20,
        borderWidth: 1.5,
        borderColor: '#F1F5F9',
        marginBottom: 25,
    },
    searchBarActive: {
        borderColor: colors.primary,
        backgroundColor: '#FFF',
    },
    searchText: {
        marginLeft: 12,
        fontSize: 15,
        color: colors.textSecondary,
        fontWeight: '600',
    },
    searchTextActive: {
        fontSize: 16,
        fontWeight: '700',
        color: colors.text,
    },
    destinationDot: {
        width: 10,
        height: 10,
        borderRadius: 5,
        backgroundColor: colors.primary,
        marginRight: 12,
    },
    primaryBtn: {
        backgroundColor: '#FFF',
        width: '100%',
        height: 50,
        borderRadius: 14,
        justifyContent: 'center',
        alignItems: 'center',
        marginTop: 20,
        backgroundColor: colors.primary
    },
    primaryBtnText: {
        color: '#FFF',
        fontSize: 18,
        fontWeight: '900',
    },
    // Search Screen
    searchContainer: {
        ...StyleSheet.absoluteFillObject,
        backgroundColor: '#FFF',
        zIndex: 100,
    },
    searchHeader: {
        flexDirection: 'row',
        alignItems: 'center',
        justifyContent: 'space-between',
        paddingHorizontal: 20,
        paddingVertical: 15,
        borderBottomWidth: 1,
        borderBottomColor: '#F8FAFC',
    },
    headerTitlePink: {
        fontSize: 16,
        fontWeight: '900',
        color: colors.primary,
        textTransform: 'uppercase',
    },
    inputsWrapper: {
        flexDirection: 'row',
        padding: 20,
        backgroundColor: '#FFF',
        paddingBottom: 25,
    },
    timelineContainer: {
        alignItems: 'center',
        marginRight: 15,
        paddingVertical: 12,
    },
    blueDot: { width: 10, height: 10, borderRadius: 5, backgroundColor: '#3B82F6' },
    dottedLine: { flex: 1, width: 1, backgroundColor: '#E2E8F0', marginVertical: 4 },
    pinkDot: { width: 10, height: 10, borderRadius: 5, backgroundColor: colors.primary, borderWidth: 2, borderColor: colors.primary },
    inputsColumn: { flex: 1 },
    inputBox: { height: 44, justifyContent: 'center', borderBottomWidth: 1, borderBottomColor: '#F1F5F9', marginBottom: 4 },
    inputTextStatic: { fontSize: 15, fontWeight: '600', color: colors.text },
    inputDivider: { height: 1 },
    inputBoxActive: {
        height: 44,
        flexDirection: 'row',
        alignItems: 'center',
        justifyContent: 'space-between',
        backgroundColor: '#FDF2F5',
        borderRadius: 8,
        paddingHorizontal: 10,
        marginTop: 4,
    },
    inputTextActive: { fontSize: 16, fontWeight: '700', color: colors.text, flex: 1 },
    resultsList: { flex: 1, backgroundColor: '#FFF', paddingHorizontal: 20, paddingTop: 10 },
    resultItem: {
        flexDirection: 'row',
        alignItems: 'center',
        paddingVertical: 16,
        borderBottomWidth: 1,
        borderBottomColor: '#F8FAFC',
    },
    resultIconBox: {
        width: 40,
        height: 40,
        borderRadius: 20,
        backgroundColor: '#FDF2F5',
        justifyContent: 'center',
        alignItems: 'center',
        marginRight: 15,
    },
    resultInfo: { flex: 1 },
    resultName: { fontSize: 16, fontWeight: '800', color: colors.text, marginBottom: 2 },
    resultAddress: { fontSize: 13, color: colors.textSecondary, fontWeight: '500' },

    // Service Selection
    handleBar: {
        width: 40,
        height: 5,
        backgroundColor: '#E2E8F0',
        borderRadius: 2.5,
        alignSelf: 'center',
        marginBottom: 20,
    },
    sheetTitleCallback: {
        fontSize: 16,
        fontWeight: '900',
        color: colors.primary,
        textTransform: 'uppercase',
    },
    selectionHeader: {
        flexDirection: 'row',
        justifyContent: 'space-between',
        alignItems: 'center',
        marginBottom: 20,
    },
    serviceItem: {
        flexDirection: 'row',
        alignItems: 'center',
        justifyContent: 'space-between',
        padding: 15,
        borderRadius: 20,
        backgroundColor: '#F8FAFC',
        marginBottom: 10,
        borderWidth: 2,
        borderColor: 'transparent',
    },
    serviceItemActive: {
        backgroundColor: '#FDF2F5',
        borderColor: colors.primary,
    },
    serviceLeft: { flexDirection: 'row', alignItems: 'center' },
    serviceIconBox: { marginRight: 15 },
    serviceName: { fontSize: 16, fontWeight: '900', color: colors.text },
    serviceCapacity: { fontSize: 12, fontWeight: '600', color: colors.textSecondary },
    servicePrice: { fontSize: 18, fontWeight: '950', color: colors.text },

    // Overlays
    overlay: {
        ...StyleSheet.absoluteFillObject,
        backgroundColor: 'rgba(233, 30, 99, 0.95)',
        justifyContent: 'center',
        alignItems: 'center',
        padding: 30,
    },
    radarContainer: {
        width: 120,
        height: 120,
        borderRadius: 60,
        backgroundColor: 'rgba(255,255,255,0.2)',
        justifyContent: 'center',
        alignItems: 'center',
        marginBottom: 30,
    },
    radarRing: {
        position: 'absolute',
        width: 140,
        height: 140,
        borderRadius: 70,
        borderWidth: 2,
        borderColor: 'rgba(255,255,255,0.3)',
    },
    overlayTitle: {
        fontSize: 28,
        fontWeight: '950',
        color: '#FFF',
        textAlign: 'center',
        marginBottom: 10,
    },
    overlaySub: {
        fontSize: 16,
        color: 'rgba(255,255,255,0.8)',
        textAlign: 'center',
        marginBottom: 40,
    },
    cancelText: {
        color: '#FFF',
        fontWeight: '800',
    },
    cancelBtn: {
        backgroundColor: 'rgba(255,255,255,0.2)',
        paddingHorizontal: 30,
        paddingVertical: 15,
        borderRadius: 14,
        borderWidth: 1,
        borderColor: 'rgba(255,255,255,0.4)',
    },

    // Driver
    acceptedHeader: { alignItems: 'center', marginBottom: 20 },
    driverAvatarLarge: {
        width: 80,
        height: 80,
        borderRadius: 40,
        backgroundColor: colors.primary,
        justifyContent: 'center',
        alignItems: 'center',
        marginBottom: 15,
        ...colors.shadow,
    },
    avatarText: { fontSize: 32, fontWeight: '900', color: '#FFF' },
    acceptedTitle: { fontSize: 24, fontWeight: '950', color: colors.text, textAlign: 'center' },
    acceptedSubtitle: { fontSize: 15, color: colors.textSecondary, textAlign: 'center', marginTop: 5, fontWeight: '600' },
    actionButtons: { flexDirection: 'row', gap: 15, marginTop: 10 },
    actionBtn: {
        flex: 1,
        backgroundColor: colors.primary,
        height: 50,
        borderRadius: 14,
        justifyContent: 'center',
        alignItems: 'center',
    },
    actionBtnText: { color: '#FFF', fontSize: 18, fontWeight: '800' },

    // Payment
    paymentCard: {
        backgroundColor: '#FFF',
        width: '100%',
        borderRadius: 32,
        padding: 30,
        alignItems: 'center',
        ...colors.shadow,
    },
    paymentIconBox: {
        width: 80,
        height: 80,
        borderRadius: 40,
        backgroundColor: '#FDF2F5',
        justifyContent: 'center',
        alignItems: 'center',
        marginBottom: 20,
    },
    paymentTitle: { fontSize: 22, fontWeight: '900', color: colors.text, marginBottom: 10 },
    paymentSub: { fontSize: 14, color: colors.textSecondary, textAlign: 'center', fontWeight: '600', lineHeight: 20, marginBottom: 25 },
    finalFareBox: {
        backgroundColor: '#F8FAFC',
        width: '100%',
        padding: 20,
        borderRadius: 20,
        alignItems: 'center',
        marginBottom: 25,
    },
    finalFareLabel: { fontSize: 12, fontWeight: '800', color: colors.textSecondary, textTransform: 'uppercase' },
    finalFareValue: { fontSize: 30, fontWeight: '950', color: colors.text, marginTop: 5 },
    loadingSpinnerSmall: { flexDirection: 'row', alignItems: 'center', gap: 10 },
    spinnerIcon: {},
    waitingText: { fontSize: 14, fontWeight: '800', color: colors.primary },
    successIcon: { marginBottom: 30 },

    // Ongoing Specific
    ongoingHeader: {
        width: '100%',
        alignItems: 'center',
        justifyContent: 'center',
        marginBottom: 30,
    },
    statusBadge: {
        backgroundColor: '#DCFCE7', // Brand Green Light
        paddingVertical: 6,
        paddingHorizontal: 12,
        borderRadius: 12,
        marginBottom: 8,
    },
    statusBadgeText: {
        color: '#166534', // Brand Green Dark
        fontSize: 11,
        fontWeight: '800',
        textTransform: 'uppercase',
        letterSpacing: 0.5,
    },
    ongoingPrice: {
        fontSize: 40,
        fontWeight: '900',
        color: colors.text,
        letterSpacing: -1.5,
        lineHeight: 48,
    },
    driverMinimalCard: {
        flexDirection: 'row',
        alignItems: 'center',
        backgroundColor: '#F8FAFC',
        padding: 15,
        borderRadius: 20,
        marginBottom: 20,
    },
    driverAvatarSmall: {
        width: 44,
        height: 44,
        borderRadius: 18,
        backgroundColor: '#E2E8F0',
        justifyContent: 'center',
        alignItems: 'center',
    },
    avatarTextSmall: {
        fontSize: 18,
        fontWeight: '900',
        color: colors.textSecondary,
    },
    driverMinimalDetails: {
        flex: 1,
        marginLeft: 12,
    },
    driverNameSmall: {
        fontSize: 15,
        fontWeight: '900',
        color: colors.text,
    },
    driverCarSmall: {
        fontSize: 12,
        color: colors.textSecondary,
        fontWeight: '600',
        marginTop: 2,
    },
    chatIconBtn: {
        width: 40,
        height: 40,
        borderRadius: 20,
        backgroundColor: '#FFF',
        justifyContent: 'center',
        alignItems: 'center',
        ...colors.shadow,
    },
    progressPlaceholder: {
        marginBottom: 10,
    },
    progressBar: {
        height: 8,
        backgroundColor: '#F1F5F9',
        borderRadius: 4,
        overflow: 'hidden',
    },
    progressFill: {
        height: '100%',
        backgroundColor: colors.primary,
    },
    etaBox: {
        flexDirection: 'row',
        alignItems: 'center',
        justifyContent: 'center',
        gap: 8,
        marginTop: 15,
        backgroundColor: '#FDF2F5',
        paddingVertical: 10,
        paddingHorizontal: 20,
        borderRadius: 20,
        alignSelf: 'center',
    },
    etaText: {
        fontSize: 13,
        fontWeight: '700',
        color: colors.textSecondary,
    },
});
